# LX Music API Server Node.js 重构 - 第二阶段任务细化文档

## 概述

第二阶段是核心功能实现阶段，基于第一阶段已完成的基础架构，实现插件系统、缓存系统、安全模块、代理功能、元数据处理和 WebDAV 支持等核心功能。本文档详细说明每个子任务的具体实现内容，并提供原项目对应功能的参考文件路径。

## 任务分解

### 1. 插件系统架构实现（优先级：高）✅ **已完成**

#### 1.1 插件基类设计 ✅ **已完成**
**任务内容**：
- ✅ 创建 `src/plugins/base.ts`，定义抽象插件基类
- ✅ 定义标准接口：search、getUrl、getLyric、getInfo、getMV（可选）
- ✅ 实现生命周期方法：onLoad、onUnload
- ✅ 定义插件元数据：name、version、author、description

**原项目参考**：
- 模块加载机制：`lx-music-api-server/common/utils.py` (require 函数)
- 模块接口定义：`lx-music-api-server/modules/__init__.py` (handleRequest 函数)
- 各音乐源模块示例：
  - `lx-music-api-server/modules/kg/*.py` (酷狗音乐)
  - `lx-music-api-server/modules/tx/*.py` (QQ音乐)
  - `lx-music-api-server/modules/wy/*.py` (网易云音乐)

**关键实现点**：
- 使用 TypeScript 抽象类确保接口一致性
- 支持异步方法和错误处理
- 提供插件配置和状态管理

#### 1.2 插件加载器 ✅ **已完成**
**任务内容**：
- ✅ 创建 `src/plugins/loader.ts`，实现动态插件加载
- ✅ 支持内置插件和外部脚本插件
- ✅ 实现热重载机制
- ✅ 提供插件注册表和查找功能

**原项目参考**：
- 动态模块加载：`lx-music-api-server/common/utils.py` (第184-218行)
- 模块缓存管理：`lx-music-api-server/modules/__init__.py` (module_cache)
- 请求分发逻辑：`lx-music-api-server/apis/main.py` (music_api 路由)

**关键实现点**：
- 使用 Map 管理插件实例
- 实现插件依赖检查
- 支持插件优先级和失败切换

#### 1.3 外部脚本插件支持 ✅ **已完成**
**任务内容**：
- ✅ 创建 `src/plugins/external/index.ts`，支持 JavaScript 脚本
- ✅ 实现脚本下载和缓存机制
- ✅ 创建 Worker 线程执行环境
- ✅ 模拟 LX Music 运行时 API

**原项目参考**：
- 外部脚本支持：`lx-music-api-server/modules/external_script.py`
- 脚本运行时模拟：`lx-music-api-server/modules/external_script.py` (第74-167行)
- 脚本下载逻辑：`lx-music-api-server/modules/external_script.py` (download_script_if_not_exist)
- 脚本缓存目录：`external_scripts/`

**关键实现点**：
- 使用 worker_threads 隔离脚本执行
- 实现 HTTP 请求代理和结果转换
- 支持脚本版本管理和更新

### 2. 缓存系统实现（优先级：高）

#### 2.1 内存缓存层
**任务内容**：
- 创建 `src/core/cache/memory.ts`
- 实现 LRU 缓存算法
- 支持 TTL 过期机制
- 提供内存使用限制

**原项目参考**：
- 内存缓存使用：`lx-music-api-server/modules/__init__.py` (fetching_url_cache 等)
- 缓存键生成：`lx-music-api-server/modules/__init__.py` (第50-80行)
- 过期时间配置：`lx-music-api-server/modules/__init__.py` (cache_expiration_time)

**关键实现点**：
- 使用 node-cache 或自实现 LRU
- 支持大小限制和自动清理
- 实现缓存统计和监控

#### 2.2 Redis 缓存层
**任务内容**：
- 创建 `src/core/cache/redis.ts`
- 实现 Redis 客户端封装
- 支持分布式缓存场景
- 实现缓存键命名规范

**原项目参考**：
- Redis 适配器：`lx-music-api-server/common/config_adapters/redis_adapter.py`
- 缓存操作接口：`lx-music-api-server/common/config_adapters/__init__.py`
- Redis 配置：`config/config.yml` (cache 部分)

**关键实现点**：
- 使用 ioredis 客户端
- 支持连接池和重试机制
- 实现发布订阅缓存更新

#### 2.3 SQLite 持久化层
**任务内容**：
- 创建 `src/core/cache/sqlite.ts`
- 设计缓存表结构
- 实现 CRUD 操作
- 支持数据迁移

**原项目参考**：
- SQLite 适配器：`lx-music-api-server/common/config_adapters/sqlite_adapter.py`
- 数据库初始化：`lx-music-api-server/common/config_adapters/sqlite_adapter.py` (第15-42行)
- 缓存表结构：cache、lyric、info、ban_list 表

**关键实现点**：
- 使用 better-sqlite3 同步 API
- 实现批量操作优化
- 支持索引和查询优化

#### 2.4 缓存管理器
**任务内容**：
- 创建 `src/core/cache/manager.ts`
- 实现三级缓存协调
- 支持缓存预热和回写
- 提供统一的缓存接口

**原项目参考**：
- 缓存管理逻辑：`lx-music-api-server/modules/__init__.py` (getCache, setCache 等)
- 音频缓存管理：`lx-music-api-server/modules/__init__.py` (第465-568行)
- 缓存文件索引：`lx-music-api-server/common/config.py` (getAudioCacheFiles)

**关键实现点**：
- 实现缓存穿透保护
- 支持并发请求合并
- 提供缓存监控指标

### 3. 安全模块（优先级：高）

#### 3.1 认证系统
**任务内容**：
- 创建 `src/core/security/auth.ts`
- 实现 API Key 验证
- 支持 LXM 自定义头部验证
- 实现请求签名机制

**原项目参考**：
- 安全模块：`lx-music-api-server/common/lxsecurity.py`
- 请求验证：`lx-music-api-server/common/lxsecurity.py` (chechLXMRequestKey)
- 密钥验证：`lx-music-api-server/common/lxsecurity.py` (checkKey)
- 中间件应用：`lx-music-api-server/main.py` (第45-49行)

**关键实现点**：
- 支持多种认证方式
- 实现认证缓存优化
- 提供认证失败处理

#### 3.2 限流系统
**任务内容**：
- 创建 `src/core/security/rateLimit.ts`
- 实现滑动窗口限流算法
- 支持全局和 IP 级别限流
- 集成 Redis 分布式限流

**原项目参考**：
- 限流中间件：`lx-music-api-server/common/lxsecurity.py` (requestRateLimiter)
- 限流配置：`config/config.yml` (security.rate_limit)
- IP 统计：`lx-music-api-server/common/lxsecurity.py` (request_count_per_ip)

**关键实现点**：
- 使用令牌桶或漏桶算法
- 支持动态限流规则
- 提供限流告警机制

#### 3.3 IP 封禁系统
**任务内容**：
- 创建 `src/core/security/ipBan.ts`
- 实现 IP 黑白名单
- 支持临时和永久封禁
- 提供封禁规则管理

**原项目参考**：
- IP 封禁：`lx-music-api-server/common/lxsecurity.py` (checkBan, ban_ip)
- 封禁列表管理：`lx-music-api-server/common/config.py` (getBanList, setBan, clearBan)
- 白名单配置：`config/config.yml` (security.whitelist_host)

**关键实现点**：
- 支持 CIDR 范围封禁
- 实现自动解封机制
- 提供封禁日志审计

### 4. 代理和下载功能（优先级：高）

#### 4.1 HTTP/HTTPS 代理
**任务内容**：
- 创建 `src/core/proxy/http.ts`
- 实现请求转发和响应流式传输
- 支持请求头修改和注入
- 处理 SSL 证书验证

**原项目参考**：
- 代理设置：`lx-music-api-server/common/Httpx.py`
- 请求客户端：`lx-music-api-server/common/utils.py` (createHttpClient)
- SSL 配置：`lx-music-api-server/common/utils.py` (第44-75行)

**关键实现点**：
- 使用 http-proxy-middleware
- 支持连接池复用
- 实现请求重试机制

#### 4.2 音频下载服务
**任务内容**：
- 创建 `src/services/audioCache.ts`
- 实现后台下载队列
- 支持断点续传
- 防止重复下载

**原项目参考**：
- 音频缓存下载：`lx-music-api-server/modules/__init__.py` (downloadAudioCache)
- 下载逻辑：`lx-music-api-server/modules/__init__.py` (第503-568行)
- 并发控制：`lx-music-api-server/modules/__init__.py` (downloading_audio_cache)
- 文件名生成：`lx-music-api-server/modules/__init__.py` (generateCacheAudioName)

**关键实现点**：
- 使用 got 进行流式下载
- 实现原子性文件操作
- 支持下载进度回调

#### 4.3 WebDAV 代理
**任务内容**：
- 创建 `src/core/proxy/webdav.ts`
- 实现 WebDAV 协议支持
- 处理认证和权限
- 支持文件列表和流式传输

**原项目参考**：
- WebDAV 路由：`lx-music-api-server/apis/main.py` (webdav_api)
- 请求转发：`lx-music-api-server/apis/main.py` (第97-117行)
- WebDAV 客户端：`lx-music-api-server/common/config.py` (webdav_client)

**关键实现点**：
- 实现 PROPFIND 等 WebDAV 方法
- 支持基本认证和摘要认证
- 处理特殊字符编码

### 5. 元数据处理（优先级：中）

#### 5.1 ID3 标签处理
**任务内容**：
- 创建 `src/core/metadata/id3.ts`
- 实现 MP3 文件元数据读写
- 支持专辑封面嵌入
- 处理编码问题

**原项目参考**：
- ID3 处理：`lx-music-api-server/common/id3_metadata.py`
- 元数据嵌入：`lx-music-api-server/modules/__init__.py` (handleAudioCache)
- 标签字段：title、artist、album、lyrics、cover
- 编码处理：UTF-8 编码

**关键实现点**：
- 使用 node-id3 库
- 支持 ID3v1 和 ID3v2
- 实现图片格式转换

#### 5.2 FLAC 元数据处理
**任务内容**：
- 创建 `src/core/metadata/flac.ts`
- 实现 FLAC 文件元数据读写
- 支持 Vorbis Comment
- 处理高清封面

**原项目参考**：
- FLAC 处理：`lx-music-api-server/common/flac_metadata.py`
- 元数据字段：TITLE、ARTIST、ALBUM、LYRICS
- 封面处理：PICTURE block type 3

**关键实现点**：
- 使用 flac-metadata 库
- 支持流式处理
- 优化大文件性能

### 6. WebDAV 功能（优先级：中）

#### 6.1 WebDAV 客户端
**任务内容**：
- 创建 `src/services/webdav.ts`
- 实现标准 WebDAV 操作
- 支持文件列表获取
- 处理认证和 SSL

**原项目参考**：
- WebDAV 客户端：`lx-music-api-server/common/config.py` (第213-231行)
- 认证配置：`config/config.yml` (webdav 部分)
- 操作方法：PROPFIND、GET、PUT

**关键实现点**：
- 使用 webdav 客户端库
- 实现连接池管理
- 支持错误重试

#### 6.2 索引管理
**任务内容**：
- 实现音频索引更新
- 支持本地音乐索引
- 管理封面索引
- 定期刷新机制

**原项目参考**：
- 音频索引：`lx-music-api-server/common/config.py` (updateAudioCacheIndex)
- 本地音乐索引：`lx-music-api-server/common/localMusic.py`
- 索引更新：`lx-music-api-server/common/scheduler.py`
- 索引结构：`lx-music-api-server/common/config.py` (第319-403行)

**关键实现点**：
- 使用后台定时任务
- 支持增量更新
- 实现索引缓存

## 测试计划

### 单元测试
- 每个模块独立的单元测试
- Mock 外部依赖
- 覆盖率目标：80%

### 集成测试
- 模块间协作测试
- 端到端流程测试
- 性能基准测试

### 手动测试
- 各音乐平台兼容性
- 缓存命中率验证
- 安全功能验证

## 时间安排

### 第1周：插件系统
- 前3天：基础架构和加载器
- 后2天：外部脚本支持

### 第2周：缓存系统
- 前2天：内存和 Redis 缓存
- 中2天：SQLite 和管理器
- 后1天：集成测试

### 第3周：安全和代理
- 前2天：安全模块
- 后3天：代理和下载功能

### 第4周：元数据和 WebDAV
- 前2天：元数据处理
- 中2天：WebDAV 功能
- 后1天：整体测试

## 注意事项

1. **代码质量**：
   - 遵循 TypeScript 严格模式
   - 使用 ESLint 和 Prettier
   - 编写完整的 JSDoc 注释

2. **性能考虑**：
   - 避免阻塞主线程
   - 使用流式处理大文件
   - 实现连接池复用

3. **错误处理**：
   - 统一错误类型定义
   - 实现优雅降级
   - 完整的错误日志

4. **兼容性**：
   - 保持与 Python 版本 API 兼容
   - 支持相同的配置格式
   - 确保功能完整性

5. **安全性**：
   - 输入验证和消毒
   - 防止路径遍历
   - 安全的文件操作

## 交付标准

每个子任务完成时应包含：
1. 完整的代码实现
2. 单元测试用例
3. 集成测试用例
4. API 文档更新
5. 性能测试报告

## 风险和应对

1. **加密算法兼容性**：提前验证 Node.js 加密库
2. **性能瓶颈**：使用性能分析工具定位
3. **内存泄漏**：定期进行内存分析
4. **第三方库问题**：准备备选方案

## 附录：原项目文件结构参考

```
lx-music-api-server/
├── apis/                    # API 路由定义
│   └── main.py             # 主要路由处理
├── common/                  # 公共模块
│   ├── config.py           # 配置管理
│   ├── lxsecurity.py       # 安全模块
│   ├── utils.py            # 工具函数
│   ├── Httpx.py            # HTTP 客户端
│   ├── id3_metadata.py     # ID3 元数据
│   ├── flac_metadata.py    # FLAC 元数据
│   ├── localMusic.py       # 本地音乐
│   └── scheduler.py        # 定时任务
├── modules/                 # 音乐源模块
│   ├── __init__.py         # 模块管理
│   ├── external_script.py  # 外部脚本
│   ├── kg/                 # 酷狗音乐
│   ├── kw/                 # 酷我音乐
│   ├── mg/                 # 咪咕音乐
│   ├── tx/                 # QQ音乐
│   └── wy/                 # 网易云音乐
└── config/                  # 配置文件
    └── config.yml          # 主配置文件
```